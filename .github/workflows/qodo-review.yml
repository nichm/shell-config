# Qodo AI PR Review Workflow v2.25.0
# Automated AI-powered code reviews, improvements and PR descriptions using qodo-ai/pr-agent@v0.31
#
# RELATED FILES (Repo-Agnostic Template):
# - .github/workflows/qodo-review.yml (this file)
# - .github/scripts/load-qodo-instructions.sh
# - .github/prompts/qodo-review.txt (or .github/prompts/qodo-review.md)
# - .github/qodo-prompts/repo-prompts.txt (fallback)
# - .github/qodo-instructions.md (fallback)
#
# This workflow is designed to work in any repository. It automatically:
# - Loads custom instructions from .github/prompts/qodo-review.txt
# - Creates/updates Qodo review labels (mega/improve status badges)
# - Runs comprehensive PR reviews with Mega Reviewer (Xiaomi Mimo v2 Flash)
# - Runs quick improvements with Mistral Devstral 2512 + KAT Coder Pro
# - Only Mega Reviewer runs on synchronize events (subsequent commits)
# - Quick Improvers only run on initial PR open/reopen
#
# CHANGELOG:
# v2.25.0: Updated to 2025 AI models - Xiaomi Mimo v2 Flash, Mistral Devstral 2512, KAT Coder Pro
#          Added 5 fallback models for each role, improved model strategy
# v2.24.0: Version bump, added comprehensive file documentation, verified repo-agnostic setup
# v2.23.0: Made workflow repo-agnostic, changed prompt file to generic repo-prompts.txt
# v2.22.0: Updated model configuration - Grok 4.1 Fast as Mega Reviewer, BERT Nebulon Alpha + KAT Coder Pro as Quick Improvers
# v2.21.0: Moved workflow to main .github/workflows directory, updated to use only txt prompt files, removed md dependency
# v2.20.0: Consolidated workflow configuration in main workflows directory
# v2.19.0: Fixed context loading issue by switching to plain text format to avoid shell quote interpretation
# v2.18.2: Fixed critical heredoc syntax bug in load script, shellcheck optimization, improved file naming
# v2.18.1: Added configuration flags (REQUIRE_ESTIMATE_EFFORT_TO_REVIEW=false, ENABLE_REVIEW_LABELS_SECURITY=false,
#          ENABLE_REVIEW_LABELS_EFFORT=false)
# v2.18.0: Refactored to self-contained folder structure with clear naming convention
#
# TRIGGERS:
# - Auto-runs on PR open/reopen (skip docs-only changes)
# - Manual dispatch for specific PR review
# - Manual commands: /review, /improve, /describe
#
# MODEL ROLES:
# - Mega Reviewer (Xiaomi Mimo v2 Flash): Main comprehensive reviewer (runs /review /improve /describe)
# - Quick Improver 1 (Mistral Devstral 2512): Fast initial improvements (/improve only)
# - Quick Improver 2 (KAT Coder Pro): Secondary improvements pass (/improve only)
#
# STATUS LABELS:
# - üîç qodo-mega: Mega Reviewer in progress (ORANGE)
# - üîç qodo-mega-done: Mega Reviewer completed successfully (GREEN)
# - üîç qodo-mega-failed: Mega Reviewer failed (RED)
# - üîç qodo-improve: Quick Improvers in progress (ORANGE)
# - üîç qodo-improve-done: Quick Improvers completed successfully (GREEN)
# - üîç qodo-improve-failed: Quick Improvers failed (RED)
#
# SECRETS REQUIRED:
# - QODO_OPENROUTER_API_KEY: OpenRouter API key
# - CLOUDFLARE_ACCOUNT_ID: Cloudflare account ID
# - QODO_CLOUDFLARE_GATEWAY_NAME: Cloudflare gateway name

name: Qodo AI PR Review

"on":
  # Manual trigger option
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (leave empty to review latest PR)"
        required: false
        type: string

  # Auto-run on new/updated PRs
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  # Mega Reviewer - Grok 4.1 Fast (Review + Improve + Describe)
  qodo_mega_reviewer:
    if: >-
      ${{
        (
          github.event_name == 'pull_request' &&
          github.event.pull_request.draft == false &&
          (
            github.event.sender.type != 'Bot' ||
            github.event.sender.login == 'dependabot[bot]' ||
            contains(github.event.sender.login, 'claude')
          )
        ) ||
        (github.event_name == 'workflow_dispatch') ||
        (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          (
            contains(github.event.comment.body, '/improve') ||
            contains(github.event.comment.body, '/describe') ||
            contains(github.event.comment.body, '/review')
          )
        )
      }}
    runs-on: ubicloud-standard-2
    timeout-minutes: 10
    continue-on-error: true
    permissions:
      issues: write
      pull-requests: write
      contents: write
      actions: write
    name: Mega Reviewer (Xiaomi Mimo v2 Flash)
    steps:
      - name: Docker Cache for Qodo Jobs
        uses: actions/cache@v5.0.3
        with:
          path: /var/lib/docker
          key: qodo-docker-${{ github.event.pull_request.number || github.sha }}-${{ github.run_attempt }}
          restore-keys: |
            qodo-docker-${{ github.event.pull_request.number || github.sha }}-
            qodo-docker-

      - name: Set PR Context for Manual Runs
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ github.event.inputs.pr_number }}';
            if (prNumber) {
              core.exportVariable('TARGET_PR', prNumber);
            } else {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'updated',
                direction: 'desc',
                per_page: 1
              });
              if (prs.length > 0) {
                core.exportVariable('TARGET_PR', prs[0].number);
                console.log(`Found latest PR: #${prs[0].number}`);
              } else {
                core.setFailed('No open PRs found to review');
              }
            }

      - name: Create/Update Labels with Correct Colors
        uses: actions/github-script@v8
        with:
          script: |
            const labelsToCreate = [
              { name: 'üîç qodo-mega', color: 'f97316', description: 'Mega Reviewer in progress' },
              { name: 'üîç qodo-mega-done', color: '22c55e', description: 'Mega Reviewer completed successfully' },
              { name: 'üîç qodo-mega-failed', color: 'ef4444', description: 'Mega Reviewer failed' },
              { name: 'üîç qodo-improve', color: 'f97316', description: 'Quick Improvers in progress' },
              { name: 'üîç qodo-improve-done', color: '22c55e', description: 'Quick Improvers completed successfully' },
              { name: 'üîç qodo-improve-failed', color: 'ef4444', description: 'Quick Improvers failed' }
            ];

            for (const label of labelsToCreate) {
              try {
                const existingLabel = await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });

                // Update color if it's incorrect
                if (existingLabel.data.color !== label.color) {
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`‚úÖ Updated label color: ${label.name} ‚Üí ${label.color}`);
                } else {
                  console.log(`Label already exists with correct color: ${label.name}`);
                }
              } catch (error) {
                if (error.status === 404) {
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    console.log(`‚úÖ Created label: ${label.name} (${label.color})`);
                  } catch (createError) {
                    console.log(`Could not create label ${label.name}:`, createError.message);
                  }
                } else {
                  console.log(`Error checking label ${label.name}:`, error.message);
                }
              }
            }

      - name: Clean Up Existing Labels
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            // Only remove Mega Reviewer labels (not Quick Improvers labels)
            const labelsToRemove = [
              'üîç qodo-mega', 'üîç qodo-mega-done', 'üîç qodo-mega-failed'
            ];

            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              for (const labelName of labelsToRemove) {
                const existingLabel = labels.find(label => label.name === labelName);
                if (existingLabel) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      name: labelName
                    });
                    console.log(`Removed label: ${labelName}`);
                  } catch (error) {
                    console.log(`Could not remove label ${labelName}:`, error.message);
                  }
                }
              }
            } catch (error) {
              console.log('Error checking labels:', error.message);
            }

      - name: Add Mega Working Label
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['üîç qodo-mega']
              });
              console.log('‚úÖ Added: üîç qodo-mega');
            } catch (error) {
              console.log('Error adding mega-working label:', error.message);
            }

      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Load Qodo Instructions
        run: |
          chmod +x .github/scripts/load-qodo-instructions.sh
          bash .github/scripts/load-qodo-instructions.sh

      - name: Verify Qodo Instructions Loaded
        run: |
          if [ -z "${PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS:-}" ]; then
            echo "‚ö†Ô∏è Warning: PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS not set - Qodo will use defaults"
          else
            LEN=${#PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS}
            echo "‚úÖ PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS loaded ($LEN chars)"
          fi

          if [ -z "${PR_REVIEWER_EXTRA_INSTRUCTIONS:-}" ]; then
            echo "‚ö†Ô∏è Warning: PR_REVIEWER_EXTRA_INSTRUCTIONS not set - Qodo will use defaults"
          else
            LEN=${#PR_REVIEWER_EXTRA_INSTRUCTIONS}
            echo "‚úÖ PR_REVIEWER_EXTRA_INSTRUCTIONS loaded ($LEN chars)"
          fi

      - name: Mega Reviewer Comprehensive Analysis
        id: mega-review
        uses: qodo-ai/pr-agent@v0.31
        env:
          OPENROUTER__KEY: ${{ secrets.QODO_OPENROUTER_API_KEY }}
          OPENROUTER__API_BASE: >-
            https://gateway.ai.cloudflare.com/v1/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/${{
              secrets.QODO_CLOUDFLARE_GATEWAY_NAME
            }}/openrouter/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          config.model: "openrouter/xiaomi/mimo-v2-flash:free"
          config.fallback_models: >-
            ["openrouter/nex-agi/deepseek-v3.1-nex-n1:free", "openrouter/tngtech/deepseek-r1t2-chimera:free",
            "openrouter/tngtech/deepseek-r1t-chimera:free", "openrouter/qwen/qwen3-coder:free", "openrouter/openai/gpt-oss-20b:free"]
          CONFIG__CUSTOM_MODEL_MAX_TOKENS: "147456" # ~90% of 163.8K actual limit for safety margin
          # DEBUGGING & LOGGING CONFIGURATION (Temporary)
          config.verbosity_level: "2" # Maximum verbosity for debugging
          config.log_level: "DEBUG" # Enable debug logging
          github.ratelimit_retries: "5" # Retry rate-limited requests
          github.publish_inline_comments_fallback_with_verification: "true" # Fallback for invalid comments
          github.try_fix_invalid_inline_comments: "true" # Attempt to fix invalid comments
          # Auto-run all commands on new PRs (comprehensive analysis)
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          # Describe configuration
          PR_DESCRIPTION__PUBLISH_DESCRIPTION: "true"
          PR_DESCRIPTION__PUBLISH_LABELS: "false"
          PR_DESCRIPTION__ADD_ORIGINAL_USER_DESCRIPTION: "false"
          PR_DESCRIPTION__GENERATE_AI_TITLE: "true"
          PR_DESCRIPTION__ENABLE_PR_DIAGRAM: "true"
          PR_DESCRIPTION__INCLUDE_GENERATED_BY_HEADER: "false"
          # Review configuration
          PR_REVIEWER__PUBLISH_REVIEW: "true"
          PR_REVIEWER__PERSISTENT_COMMENT: "true"
          PR_REVIEWER__FINAL_UPDATE_MESSAGE: "true"
          PR_REVIEWER__NUM_MAX_FINDINGS: "8"
          PR_REVIEWER__REQUIRE_SCORE_REVIEW: "false"
          PR_REVIEWER__REQUIRE_TESTS_REVIEW: "false"
          PR_REVIEWER__REQUIRE_ESTIMATE_CONTRIBUTION_TIME_COST: "false"
          PR_REVIEWER__REQUIRE_ESTIMATE_EFFORT_TO_REVIEW: "false"
          PR_REVIEWER__ENABLE_REVIEW_LABELS_SECURITY: "false"
          PR_REVIEWER__ENABLE_REVIEW_LABELS_EFFORT: "false"
          # Improve configuration
          PR_CODE_SUGGESTIONS__PUBLISH_CODE_SUGGESTIONS: "true"
          PR_CODE_SUGGESTIONS__PUBLISH_OUTPUT_NO_SUGGESTIONS: "false"
          PR_CODE_SUGGESTIONS__COMMITABLE_CODE_SUGGESTIONS: "true" # Enable inline code suggestions instead of comments
          PR_CODE_SUGGESTIONS__SUGGESTIONS_SCORE_THRESHOLD: "6" # Higher threshold for quality suggestions (0-10 scale)
          PR_CODE_SUGGESTIONS__SUGGESTIONS_DEPTH: "exhaustive" # Maximum comprehensiveness
          PR_CODE_SUGGESTIONS__NUM_BEST_PRACTICE_SUGGESTIONS: "6" # More best practice suggestions
          # Custom instructions from repo context (auto-loaded and decoded)
          pr_code_suggestions.extra_instructions: ${{ env.PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS }}
          pr_reviewer.extra_instructions: ${{ env.PR_REVIEWER_EXTRA_INSTRUCTIONS }}
          PR_CODE_SUGGESTIONS__NUM_CODE_SUGGESTIONS_PER_CHUNK: "8" # Keep at 8

      - name: Finalize Mega Reviewer Labels
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            const megaResult = '${{ steps.mega-review.outcome }}';
            const success = megaResult === 'success';

            // Remove working label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'üîç qodo-mega'
              });
            } catch (error) {
              // Label might not exist, ignore
            }

            // Add final status label
            const finalLabel = success ? 'üîç qodo-mega-done' : 'üîç qodo-mega-failed';
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [finalLabel]
              });
              console.log(`‚úÖ Mega Reviewer: ${success ? 'done' : 'failed'} - Added ${finalLabel}`);
            } catch (error) {
              console.log(`Error adding ${finalLabel}:`, error.message);
            }

  # Quick Improvers - Sequential Fast Improvements (Cost Optimization)
  # Note: Only runs on initial PR open/reopen, NOT on synchronize (subsequent commits)
  qodo_quick_improvers:
    if: >-
      ${{
        (
          github.event_name == 'pull_request' &&
          github.event.action != 'synchronize' &&
          github.event.pull_request.draft == false &&
          (
            github.event.sender.type != 'Bot' ||
            github.event.sender.login == 'dependabot[bot]' ||
            contains(github.event.sender.login, 'claude')
          )
        ) ||
        (github.event_name == 'workflow_dispatch') ||
        (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          (
            contains(github.event.comment.body, '/improve') ||
            contains(github.event.comment.body, '/describe') ||
            contains(github.event.comment.body, '/review')
          )
        )
      }}
    runs-on: ubicloud-standard-2
    timeout-minutes: 14 # Combined timeout (7+7 minutes)
    continue-on-error: true
    permissions:
      issues: write
      pull-requests: write
      contents: write
      actions: write
    name: Quick Improvers (Mistral + KAT Coder)
    steps:
      - name: Docker Cache for Qodo Jobs
        uses: actions/cache@v5.0.3
        with:
          path: /var/lib/docker
          key: qodo-docker-${{ github.event.pull_request.number || github.sha }}-${{ github.run_attempt }}
          restore-keys: |
            qodo-docker-${{ github.event.pull_request.number || github.sha }}-
            qodo-docker-

      - name: Set PR Context for Manual Runs
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ github.event.inputs.pr_number }}';
            if (prNumber) {
              core.exportVariable('TARGET_PR', prNumber);
            } else {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'updated',
                direction: 'desc',
                per_page: 1
              });
              if (prs.length > 0) {
                core.exportVariable('TARGET_PR', prs[0].number);
                console.log(`Found latest PR: #${prs[0].number}`);
              } else {
                core.setFailed('No open PRs found to review');
              }
            }

      - name: Create Labels if Missing
        uses: actions/github-script@v8
        with:
          script: |
            const labelsToCreate = [
              { name: 'üîç qodo-mega', color: 'f97316', description: 'Mega Reviewer in progress' },
              { name: 'üîç qodo-mega-done', color: '22c55e', description: 'Mega Reviewer completed successfully' },
              { name: 'üîç qodo-mega-failed', color: 'ef4444', description: 'Mega Reviewer failed' },
              { name: 'üîç qodo-improve', color: 'f97316', description: 'Quick Improvers in progress' },
              { name: 'üîç qodo-improve-done', color: '22c55e', description: 'Quick Improvers completed successfully' },
              { name: 'üîç qodo-improve-failed', color: 'ef4444', description: 'Quick Improvers failed' }
            ];

            for (const label of labelsToCreate) {
              try {
                const existingLabel = await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });

                // Update color if it's incorrect
                if (existingLabel.data.color !== label.color) {
                  await github.rest.issues.updateLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`‚úÖ Updated label color: ${label.name} ‚Üí ${label.color}`);
                } else {
                  console.log(`Label already exists with correct color: ${label.name}`);
                }
              } catch (error) {
                if (error.status === 404) {
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    console.log(`‚úÖ Created label: ${label.name} (${label.color})`);
                  } catch (createError) {
                    console.log(`Could not create label ${label.name}:`, createError.message);
                  }
                } else {
                  console.log(`Error checking label ${label.name}:`, error.message);
                }
              }
            }

      - name: Clean Up Existing Labels
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            // Only remove Quick Improvers labels (not Mega Reviewer labels)
            const labelsToRemove = [
              'üîç qodo-improve', 'üîç qodo-improve-done', 'üîç qodo-improve-failed'
            ];

            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              for (const labelName of labelsToRemove) {
                const existingLabel = labels.find(label => label.name === labelName);
                if (existingLabel) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      name: labelName
                    });
                    console.log(`Removed label: ${labelName}`);
                  } catch (error) {
                    console.log(`Could not remove label ${labelName}:`, error.message);
                  }
                }
              }
            } catch (error) {
              console.log('Error checking labels:', error.message);
            }

      - name: Add Improve Working Label
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['üîç qodo-improve']
              });
              console.log('‚úÖ Added: üîç qodo-improve');
            } catch (error) {
              console.log('Error adding improve-working label:', error.message);
            }

      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Load Qodo Instructions
        run: |
          chmod +x .github/scripts/load-qodo-instructions.sh
          bash .github/scripts/load-qodo-instructions.sh

      - name: Verify Qodo Instructions Loaded
        run: |
          if [ -z "${PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS:-}" ]; then
            echo "‚ö†Ô∏è Warning: PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS not set - Qodo will use defaults"
          else
            LEN=${#PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS}
            echo "‚úÖ PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS loaded ($LEN chars)"
          fi

          if [ -z "${PR_REVIEWER_EXTRA_INSTRUCTIONS:-}" ]; then
            echo "‚ö†Ô∏è Warning: PR_REVIEWER_EXTRA_INSTRUCTIONS not set - Qodo will use defaults"
          else
            LEN=${#PR_REVIEWER_EXTRA_INSTRUCTIONS}
            echo "‚úÖ PR_REVIEWER_EXTRA_INSTRUCTIONS loaded ($LEN chars)"
          fi

      - name: Quick Improver 1 - Mistral Devstral 2512 (Step 1/2)
        id: quick-improver-1
        uses: qodo-ai/pr-agent@v0.31
        env:
          OPENROUTER__KEY: ${{ secrets.QODO_OPENROUTER_API_KEY }}
          OPENROUTER__API_BASE: >-
            https://gateway.ai.cloudflare.com/v1/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/${{
              secrets.QODO_CLOUDFLARE_GATEWAY_NAME
            }}/openrouter/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Large Context Model Strategy (262K+ tokens)
          config.model: "openrouter/mistralai/devstral-2512:free"
          config.fallback_models: >-
            ["openrouter/qwen/qwen3-coder:free", "openrouter/openai/gpt-oss-20b:free",
            "openrouter/xiaomi/mimo-v2-flash:free", "openrouter/nex-agi/deepseek-v3.1-nex-n1:free", "openrouter/tngtech/deepseek-r1t2-chimera:free"]
          CONFIG__CUSTOM_MODEL_MAX_TOKENS: "131072" # ~90% of 131K actual limit for safety margin
          # DEBUGGING & LOGGING CONFIGURATION (Temporary)
          config.verbosity_level: "2" # Maximum verbosity for debugging
          config.log_level: "DEBUG" # Enable debug logging
          github.ratelimit_retries: "5" # Retry rate-limited requests
          github.publish_inline_comments_fallback_with_verification: "true" # Fallback for invalid comments
          github.try_fix_invalid_inline_comments: "true" # Attempt to fix invalid comments
          # Focused improvement only (no auto describe/review)
          github_action_config.auto_improve: "true"
          github_action_config.auto_review: "false"
          github_action_config.auto_describe: "false"
          # Improve configuration
          PR_CODE_SUGGESTIONS__PUBLISH_CODE_SUGGESTIONS: "true"
          PR_CODE_SUGGESTIONS__PUBLISH_OUTPUT_NO_SUGGESTIONS: "false"
          PR_CODE_SUGGESTIONS__COMMITABLE_CODE_SUGGESTIONS: "true" # Enable inline code suggestions instead of comments
          PR_CODE_SUGGESTIONS__SUGGESTIONS_SCORE_THRESHOLD: "6" # Higher threshold for quality suggestions (0-10 scale)
          PR_CODE_SUGGESTIONS__SUGGESTIONS_DEPTH: "exhaustive" # Maximum comprehensiveness
          PR_CODE_SUGGESTIONS__NUM_BEST_PRACTICE_SUGGESTIONS: "6" # More best practice suggestions
          # Custom instructions from repo context (auto-loaded by setup script)
          pr_code_suggestions.extra_instructions: ${{ env.PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS }}
          pr_reviewer.extra_instructions: ${{ env.PR_REVIEWER_EXTRA_INSTRUCTIONS }}
          PR_CODE_SUGGESTIONS__FOCUS_ONLY_ON_PROBLEMS: "true"
          PR_CODE_SUGGESTIONS__NUM_CODE_SUGGESTIONS_PER_CHUNK: "8" # Keep at 8

      - name: Quick Improver 2 - KAT Coder Pro (Step 2/2)
        id: quick-improver-2
        uses: qodo-ai/pr-agent@v0.31
        env:
          OPENROUTER__KEY: ${{ secrets.QODO_OPENROUTER_API_KEY }}
          OPENROUTER__API_BASE: >-
            https://gateway.ai.cloudflare.com/v1/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/${{
              secrets.QODO_CLOUDFLARE_GATEWAY_NAME
            }}/openrouter/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Small Context Model Strategy (~32K tokens) - Fast and Efficient
          config.model: "openrouter/kwaipilot/kat-coder-pro:free"
          config.fallback_models: >-
            ["openrouter/openai/gpt-oss-20b:free", "openrouter/qwen/qwen3-coder:free",
            "openrouter/tngtech/deepseek-r1t2-chimera:free", "openrouter/tngtech/deepseek-r1t-chimera:free", "openrouter/nex-agi/deepseek-v3.1-nex-n1:free"]
          CONFIG__CUSTOM_MODEL_MAX_TOKENS: "29491" # ~90% of 32K actual limit for safety margin
          # DEBUGGING & LOGGING CONFIGURATION (Temporary)
          config.verbosity_level: "2" # Maximum verbosity for debugging
          config.log_level: "DEBUG" # Enable debug logging
          github.ratelimit_retries: "5" # Retry rate-limited requests
          github.publish_inline_comments_fallback_with_verification: "true" # Fallback for invalid comments
          github.try_fix_invalid_inline_comments: "true" # Attempt to fix invalid comments
          # Focused improvement only (no auto describe/review)
          github_action_config.auto_improve: "true"
          github_action_config.auto_review: "false"
          github_action_config.auto_describe: "false"
          # Improve configuration
          PR_CODE_SUGGESTIONS__PUBLISH_CODE_SUGGESTIONS: "true"
          PR_CODE_SUGGESTIONS__PUBLISH_OUTPUT_NO_SUGGESTIONS: "false"
          PR_CODE_SUGGESTIONS__COMMITABLE_CODE_SUGGESTIONS: "true" # Enable inline code suggestions instead of comments
          PR_CODE_SUGGESTIONS__SUGGESTIONS_SCORE_THRESHOLD: "6" # Higher threshold for quality suggestions (0-10 scale)
          PR_CODE_SUGGESTIONS__SUGGESTIONS_DEPTH: "exhaustive" # Maximum comprehensiveness
          PR_CODE_SUGGESTIONS__NUM_BEST_PRACTICE_SUGGESTIONS: "6" # More best practice suggestions
          # Custom instructions from repo context (auto-loaded by setup script)
          pr_code_suggestions.extra_instructions: ${{ env.PR_CODE_SUGGESTIONS_EXTRA_INSTRUCTIONS }}
          pr_reviewer.extra_instructions: ${{ env.PR_REVIEWER_EXTRA_INSTRUCTIONS }}
          PR_CODE_SUGGESTIONS__FOCUS_ONLY_ON_PROBLEMS: "true"
          PR_CODE_SUGGESTIONS__NUM_CODE_SUGGESTIONS_PER_CHUNK: "8" # Keep at 8

      - name: Finalize Quick Improvers Labels
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber;
            const eventName = github.event_name || process.env.GITHUB_EVENT_NAME || context.eventName;

            if (eventName === 'workflow_dispatch') {
              prNumber = process.env.TARGET_PR;
            } else if (eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else {
              return;
            }

            if (!prNumber) return;

            const improver1Result = '${{ steps.quick-improver-1.outcome }}';
            const improver2Result = '${{ steps.quick-improver-2.outcome }}';
            const success = improver1Result === 'success' && improver2Result === 'success';

            // Remove working label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'üîç qodo-improve'
              });
            } catch (error) {
              // Label might not exist, ignore
            }

            // Add final status label
            const finalLabel = success ? 'üîç qodo-improve-done' : 'üîç qodo-improve-failed';
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [finalLabel]
              });
              console.log(`‚úÖ Quick Improvers: ${success ? 'done' : 'failed'} - Added ${finalLabel}`);
              console.log(`   Improver 1: ${improver1Result}, Improver 2: ${improver2Result}`);
            } catch (error) {
              console.log(`Error adding ${finalLabel}:`, error.message);
            }
